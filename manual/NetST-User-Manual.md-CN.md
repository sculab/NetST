# NetST 用户手册

## 1. 概述

**NetST** 是一款面向大规模多性状单倍型数据集的集成化软件平台。它支持单倍型序列识别、网络构建、可视化以及自动化分析，适用于群体遗传学、系统地理学和分子流行病学等多个研究领域。

NetST实现了单倍型网络构建和可视化的核心功能，配备完整的上游和下游分析流程，显著提升了研究效率。软件具有创新的**定量拓扑分析**功能，用于网络拓扑结构分析，帮助研究人员更好地识别网络中的主要群体、关键节点和重要连接。

此外，NetST还提供**双性状映射和相关性分析**功能，允许在单个单倍型网络中同时可视化关联性状，并对相关性状进行统计相关性分析，为系统发育关系分析提供更加全面的视角。

**核心特色**：

- 三种主流单倍型网络构建算法（TCS/MJN/MSN）
- 网络拓扑与群落结构分析（中心性、模块度）
- 创新的双性状可视化和相关性分析功能
- 一体化图形界面与流程自动化设计

## 2. 软件流程

![workflow2](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507192107232.png)

NetST 提供端到端的分析流程，涵盖数据导入、序列比对、单倍型提取、网络构建、可视化与下游分析。如下：

**1.数据导入与预处理**

- 灵活接受FASTA/CSV格式文件，支持嵌入式元数据（性状信息等）
- 利用MAFFT进行高质量序列比对
- 提供交互式界面，便于序列检查和元数据管理

**2. 单倍型鉴定**

- 基于DnaSP启发的算法处理比对后的序列
- 自动合并相同单倍型

**3. 网络构建**

- 基于高性能的fastHaN软件，实现三种主流网络构建算法：
  - **统计简约网络（TCS）**
  - **中位连接网络（MJN）**
  - **最小生成网络（MSN）**
- 输出标准化的JSON/GML格式网络文件

**4. 网络可视化**

- 采用增强版tcsBU软件实现网络渲染
- 采用同心圆策略可视化离散与连续性状
- 支持灵活的节点注释
- 支持 SVG 矢量导出

**5. 自动化分析模块**

- **定量拓扑分析**：使用优化的GN算法进行群落检测，基于模块度进行评估
- **序列统计分析**：集成主成分分析（PCA）、Tajima's D检验等经典方法
- **群体遗传学分析**：基于输入序列计算经典群体遗传学指标
- **双性状关联分析**：使用ANOVA/Kruskal-Wallis进行性状关联分析

## 3. 安装与运行NetST

* 从[NetST GitHub发布页面](https://github.com/sculab/NetST/releases)下载最新版本
* 解压后双击`NetST.exe`直接运行（无需安装）
* **注意**：请勿更改 NetST 文件夹结构，并在NetST文件夹中运行程序，所需依赖已打包在文件夹中

![The-Interface-of-NetST](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202506292123757.png)

## 4. 快速入门

### 数据格式

NetST接受FASTA或CSV格式的序列数据集。每个序列应包含样本元数据。

[Examples](https://claude.ai/Examples)目录中提供了两个示例数据集：

* SL-SARS-CoV-2：包含130个代表性单倍型，区分L/S谱系（离散性状）
* DP-SARS-CoV-2：包含482个基因组序列，标注地理位置（离散）和采集日期（连续）

### 数据导入和预处理

#### 载入数据

1. 菜单栏点击【文件 > 载入序列】
2. 选择数据文件（如：Examples/DP-SARS-CoV-2/DP-SARS-CoV-2.fasta）
3. 在弹出的标准化窗口中进行预处理

![image-20250629215748815](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202506292157869.png)

#### 数据预处理设置

在预处理窗口中，指定以下参数：

- **分隔符**：用于拆分序列ID的字符（如`|`）
- 字段位置设置
  - 0号位置：新序列名
  - 1号位置：离散性状（分类参考）
  - 2号位置：连续性状
  - 3号位置：数量信息
  - 4号位置：物种名

#### 序列管理

预处理完成后，管理界面显示关键元数据：

- ID、Name、Sequence
- Discrete Traits（离散性状）
- Continuous Trait（连续性状）
- Quantity（数量）
- Organism（物种）

**提示**：通过复选框查看并筛选特定序列参与网络构建

![image-20250629220131412](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202506292201462.png)

### 单倍型网络构建流程

#### 单倍型网络构建算法

NetST集成了三种常用的单倍型网络构建算法：

* **MSN**（Minimum Spanning Network）
* **MJN**（Median Joining Network）
* **TCS**（Templeton-Crandall-Sing, Statistical Parsimony Method）

本教程以TCS为例。

#### 网络构建步骤

1. 菜单栏点击【Analyze > TCS Haplotype Network 】
2. NetST将自动执行以下步骤
   * 多序列比对（multiple sequence alignment）
   * 单倍型序列计算（haplotype sequence calculation）
   * 单倍型网络构建（haplotype network construction）
   * 单倍型网络可视化（haplotype network visualizatio）

#### 结果界面

![image-20250630002738023](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202506300027160.png)

结果界面窗口包含三个部分：

1. 左侧面板：单倍型信息
   - 样本名称
   - 单倍型
   - 间断性状及其分类颜色
2. 中间面板：网络可视化主体
   - 采用双性状可视化策略
   - 节点以同心圆方式展示
   - 外环：离散性状（如位置信息）
   - 内环：连续性状（如采集时间）
3. 右侧面板：力导向布局设置，一般情况下无需调整

### 图形美化和导出

在可视化窗口上方包含多个功能按钮，可以用于网络图的可视化调整和美化：

![image-20250704221114652](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507042211822.png)

其中较为常用的功能：

- **图例**：显示/隐藏图例

- 风格选择

  - 连续性状模式

  - 间断性状模式

![未标题-1](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507042228483.jpg)

- **Save SVG**：保存为SVG矢量图格式

### 单倍型网络分析

![image-20250702001748773](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507020017940.png)

NetST 在提供基础的单倍型网络构建和可视化功能的同时，具有众多分析功能，包括：

* **网络拓扑分析**：自动计算中心性、连通性等指标，识别潜在重要节点和边
* **模块度分析**：使用模块度评估群落划分
* **可视化群落**：基于用户定义的K值进行群落划分
* **序列分析**：评估序列保守性和遗传距离分布
* **群体统计**：计算群体遗传学指标
* **双性状相关性分析**：双性状统计检验和潜在功能性单倍型识别

**使用方法**：通过【Analyze】菜单运行这些分析。结果将保存并在**Report**界面中显示。

### 结果管理

#### 文件输出

所有结果文件保存在NetST文件夹内的`history`子目录中

#### 查看结果

转到**Report**选项卡访问所有分析输出、摘要和可视化导出

![image-20250702111009057](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507021110180.png)

## 5. 界面导航

![The-Interface-of-NetST](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202506292123757.png)

NetST采用简洁直观的布局设计，顶部设置5个功能菜单栏：**File**（文件）、**Edit**（编辑）、**Analyze**（分析）、**Browse**（浏览）和**Tools**（工具），下方配置4个信息展示子界面：**Main**（主界面）、**Sequences**（序列）、**Report**（报告）和**Information**（信息）。

### 子界面功能说明

#### **Main**

NetST的核心工作区域，主要用于展示单倍型网络的可视化结果和分析记录。

![image-20250722205601073](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507222056982.png)

![image-20250722205738068](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507222057580.png)

#### **Sequences**

提供序列数据管理功能，包括序列的导入、编辑、查看和组织。用户可以在此界面管理多个数据集，并查看序列的性状元数据。

![image-20250722205843765](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507222058376.png)

#### **Report**

展示单倍型网络分析的详细结果，包括网络拓扑指标、群落检测结果和性状关联分析。

![image-20250722210109831](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507222101085.png)

#### **Information**

在网络构建、可视化和分析过程中显示实时日志和状态更新，允许用户跟踪过程并排除故障。

![image-20250722210251095](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507222102330.png)

### 菜单栏说明

#### 【File】菜单栏

![image-20250722184619472](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507221846541.png)

**File** 菜单提供数据输入输出的核心功能，包含以下功能：

- **Load Sequences**：导入序列FASTA格式的序列文件
- **Load Table**：加载数据表文件
- **Add Sequences**：向现有项目中添加更多序列数据
- **Save Table**：保存当前数据表为CSV格式
- **Save Sequences**：导出序列数据为FASTA格式

**FASTA格式**：每条序列包含标题行和序列数据。标题行采用管道符（|）分隔的字段结构，包含序列ID、离散性状、连续性状等元信息：

```txt
>DP0005|DP|54|1|Human
TTTCTGGCCCCCCCCTCGGCCGATTCCGCCGCGTAGCAACCGCCGCTGCACCCAGCGCTCGCTCGATTCCGAGCCACAAGCGCGGGCGTCCGAAGCCGGGACTCCCGCCGCGTCTG
```

**CSV格式**：结构化数据表，以逗号分隔的表格形式组织样本信息和性状数据：

| ID   |  Name  |   Sequence   | Discrete Traits | Continuous Traits | Quantity | Organism |
| ---- | :----: | :----------: | :-------------: | :---------------: | :------: | :------: |
| 1    | DP0005 | TTTCTGGCCCC… |       DP        |        54         |    1     |  Human   |
| 2    | DP0027 | TTTCTGGCCCC  |       DP        |        54         |    1     |  Human   |

#### 【Edit】菜单栏

![image-20250722204051739](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507222040282.png)

专门用于Sequences界面中的数据统一选择。

#### 【Analyze】菜单栏

![image-20250722204332136](https://cdn.jsdelivr.net/gh/plant720/TyporaPic/img/202507222043342.png)

NetST的核心分析模块，集成三大主要功能：

##### 单倍型网络构建

提供三种经典的网络构建算法，适用于不同的研究场景：

**MSN (Minimum Spanning Network) 最小生成网络**

- **适用对象**：亲缘关系密切的序列，低分化程度的群体研究
- **特点**：构建最简洁的连接模式，适合种内或群体水平的系统发育分析
- **应用场景**：群体遗传学研究、近期进化事件分析

**MJN (Median-Joining Network) 中位连接网络**

- **适用对象**：存在缺失数据或重组事件的复杂序列
- **特点**：能够处理网状进化关系，推断中间序列节点
- **应用场景**：复杂进化历史重建、古DNA研究、病毒进化分析

**TCS (Statistical Parsimony) 统计简约网络**

- **适用对象**：种内系统地理学研究的标准方法
- **特点**：基于95%简约性连接限制，控制连接的统计置信度
- **应用场景**：传统的系统地理学研究、物种内遗传结构分析

##### 多序列比对

集成MAFFT和MUSCLE两种主流比对算法，提供高质量的序列比对服务，支持交互式调整和批量处理功能。

**注意**：该功能主要为用户提供序列比对的可视化查看和手动调整接口。在常规分析流程中，用户无需单独执行此步骤，因为程序在进行单倍型网络构建时会自动在后台完成多序列比对。此功能特别适用于需要人工检查比对质量或进行精细调整的高要求分析场景。

##### 单倍型网络分析

NetST集成了多个高级分析模块，包含群落检测、拓扑指标计算、性状关联分析等高级分析功能，提供定量化的网络特征描述和生物学解释。

**群落检测分析**

- **模块度分析**：采用Newman模块性指标定量评估网络群落结构的统计显著性 （详见算法方法部分）
- **GN群落检测**：基于改进的Girvan-Newman算法进行单倍型网络的群落划分（详见算法方法部分）
- **拓扑指标计算**：自动计算网络的关键拓扑特征，包括中心性指标、连通性参数等

**序列分析**

- **保守性分析**：评估序列比对中各位点的进化保守程度，识别高变异区域
- **遗传距离计算**：支持P-distance、Jukes-Cantor和Kimura 2-parameter等多种距离模型
- **主成分分析**：通过PCA降维可视化单倍型间的遗传关系模式

**群体遗传学统计**

基于比对序列计算经典的群体遗传学指标：

- **单倍型多样性 (Hd)**：量化群体内单倍型的多样化程度
- **分离位点 (S)**：统计序列中的多态性位点数量
- **简约信息位点**：识别对系统发育分析有价值的变异位点
- **核苷酸多样性 (π)**：测量群体内平均核苷酸差异水平
- **Watterson's θ (θW)**：估算群体突变率参数
- **Tajima's D**：检验中性进化假说，评估选择压力和群体历史

**性状关联分析**

- **双性状整合**：同时分析离散性状（如地理来源）与连续性状（如形态指标）的关联模式 （详情见方法部分）
- **统计显著性检验**：采用ANOVA或Kruskal-Wallis检验评估性状间关联的统计学意义 
- **功能单倍型筛选**：基于综合评分系统识别具有潜在功能意义的关键单倍型 （详情见方法部分）

## 6. 方法与算法说明

### 改进的Girvan-Newman群落检测算法

Girvan-Newman (GN) 算法是一种基于图分割的层次聚类方法，广泛用于复杂网络的群落检测。该算法通过边介数中心性评估边的重要性，逐步移除作为群落间"桥梁"的关键边，从而揭示网络的潜在群落结构。

在单倍型网络中，不同单倍型通过表示突变步骤的特定边连接，这些边充当单倍型之间的桥梁。这种结构特征使得GN算法适用于单倍型网络的群落检测。然而，单倍型网络的独特生物学特性对传统GN算法的应用提出了挑战。

针对单倍型网络的特点，我们**在经典 Girvan-Newman 算法基础上引入遗传距离加权**，进行了如下改进：

**核心思想**：结合拓扑结构重要性与生物学距离信息，通过双重标准识别关键边。首先计算标准边介数中心性识别结构桥梁，随后引入指数加权函数调整介数值，该函数充分考虑单倍型间的遗传距离。这种策略确保连接高度分化序列的边（可能代表古代分化事件或多重突变积累）被优先移除，从而揭示具有生物学意义的群体结构。

#### **算法实现步骤**

**步骤 1：计算初始边介数中心性**

将网络视为无权图，计算所有边的标准介数中心性：
$$
B(i,j) = \sum_{s \neq t} \frac{\sigma_{st}(i,j)}{\sigma_{st}}
$$
其中：

- $\sigma_{st} $ 表示从节点 $s $ 到节点 $t $ 的最短路径总数
- $\sigma_{st}(i,j) $ 表示从节点 $s $ 到节点 $t $ 且经过边 $(i,j) $ 的最短路径数

**步骤 2：计算加权边介数中心性**

引入权重调整因子，计算考虑遗传距离的边介数：
$$
B_w(i,j) = \frac{B(i,j)}{w_{ij} + \varepsilon}
$$

其中：

- $w_{ij} = e^{-d_{ij}/\sigma}$ 是边 $(i,j) $ 的权重
- $d_{ij}$ 是节点 $i $ 和 $j $ 之间的遗传距离（核苷酸差异数）
- $\varepsilon $ 是防止除零的小常数
- $\sigma$是尺度参数

权重函数设计原理：$w_{ij}$ 值越小表示节点间遗传距离越大，相似性越低；通过除法运算，遗传距离较大的边将获得更高的$B_w$值，从而优先被移除。

**步骤3：边移除**

识别并移除具有最高加权介数中心性$B_w(i,j)$的边。

**步骤4：介数更新**

重新计算剩余网络中所有边的介数中心性。

**步骤5：迭代执行**

重复步骤2-4，直至网络分割为预期的群落数量或满足停止条件。

### 模块度评估

为评估群落结构的统计显著性和生物学相关性，NetST计算**Newman模块度指数（Q）**。该指标通过比较群落内观察到的边密度与随机网络中的期望密度，量化群落分割的强度。

Newman模块度的计算公式为：
$$
Q = \frac{1}{2m} \sum_{ij} \left[ A_{ij} - \frac{k_i k_j}{2m} \right] \delta(c_i, c_j)
$$
其中：

- $A_{ij}$ 表示节点$i$和$j$之间的邻接矩阵元素
- $k_i$ 和 $k_j$ 分别表示节点$i$和$j$的度数
- $m$ 表示网络中边的总数
- $c_i$ 和 $c_j$ 分别表示节点$i$和$j$所属的群落
- $\delta(c_i, c_j)$ 为Kronecker delta函数，当$c_i = c_j$时为1，否则为0

**显著性阈值**：模块度值$Q > 0.3$通常被认为表明统计显著的群落结构，支持非随机分组的存在。

#### 实际考虑

虽然最大化$Q$可以帮助发现结构，但过高的值可能源于**过度分割**，这可能产生生物学上无意义的微群落。因此，NetST推荐**基于阈值的验证**策略：

- **不要追求绝对最高的Q值**
- **关注用户定义分区的模块度是否超过0.3**

这种方法在保持生物学可解释性的同时确保统计稳健性。

#### 最佳实践

为优化群落检测：

1. **基于生物学背景或研究目标预定义群落数量**
2. **验证结果分区的模块度**（$Q > 0.3$）
3. **在上下文中解释群落**（如地理、表型）
4. **根据需要迭代**，调整参数以平衡统计和生物学考虑

### 双性状关联分析

NetST包含内置模块，用于测试与每个单倍型相关的**离散**（如谱系、区域）和**连续**性状（如采集日期、表型）之间的关系。

#### 分析策略

1. **按离散性状分组样本**
2. **比较组间连续性状值**
3. **执行统计检验**
4. **评估效应量**以确定生物学相关性

#### 分析流程

##### 步骤1：数据预处理

- 自动处理缺失值和数据格式验证
- 计算基本统计量：样本数、单倍型数、性状分布等

##### 步骤2：统计方法选择

```
IF 数据符合正态分布
    THEN ANOVA方差分析
    ELSE Kruskal-Wallis非参数检验
```

##### 步骤3：效应量计算

$\eta^2 = \frac{组间方差}{总方差}$

**解释标准**：

- $\eta^2$ = 0.01-0.06：小效应
- $\eta^2$ = 0.06-0.14：中等效应
- $\eta^2$  ≥ 0.14：大效应

##### 步骤4：显著性判定

```
显著关联 = (p < 0.05) AND (η² > 0.06)
```

只有同时满足$p < 0.05$和$\eta^2 > 0.06$的结果才被认为**显著相关**。

#### 功能性单倍型评分

为识别生物学上重要的单倍型，NetST使用**综合评分系统**评估性状定义组内的富集模式。

##### 评分标准（总分12分）

| 维度           | 分数 | 描述                     |
| -------------- | ---- | ------------------------ |
| 样本量（功效） | 0-3  | 更大的单倍型组得分更高   |
| 性状特异性     | 0–4  | 与特定性状组的关联程度   |
| 表型偏离       | 0–3  | 连续性状相对组均值的偏离 |
| 富集倍数       | 0-2  | 富集倍数                 |

**得分≥6**：表明可能具有功能重要性

#### 输出文件

双性状可视化分析部分会产生以下报告：

* **描述性统计报告**：基本数据概况和分布特征
* **组间统计分析**：各性状组的详细统计指标
* **单倍型富集分析**：所有单倍型的综合评分
* **功能性单倍型报告**：达到功能阈值的候选单倍型
* **综合分析摘要**：完整的分析流程和结果总结

## 7. 引用

如果您在研究中使用NetST，请引用：

> Zhang Z, Yu Y. NetST: An integrated software for large-scale haplotype network construction, visualization, and automated analytics.

同时请引用以下依赖项：

Chi L, Zhang X, Xue Y, Chen H. 2023. fastHaN: a fast and scalable program for constructing haplotype network for large‐sample sequences. Molecular Ecology Resources:1755-0998.13829.

Múrias Dos Santos A, Cabezas MP, Tavares AI, Xavier R, Branco M. 2016. tcsBU: a tool to extend TCS network layout and visualization. Bioinformatics 32:627–628.

Nakamura T, Yamada KD, Tomii K, Katoh K. 2018. Parallelization of MAFFT for large-scale multiple sequence alignments.Hancock J, editor. Bioinformatics 34:2490–2492.

## 8. 联系我们

如有关于NetST的任何问题、建议或意见，请随时联系：[yyu@scu.edu.cn](mailto:yyu@scu.edu.cn)，[zzhen0302@163.com](mailto:zzhen0302@163.com)。

